"""
Setup handlers for multi-tenant bot configuration.
Guides new admins through the initial setup process.
"""
import logging
from aiogram import Router, F, Bot
from aiogram.types import Message, CallbackQuery
from aiogram.filters import Command
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import State, StatesGroup
from sqlalchemy.ext.asyncio import AsyncSession

from utils.user_roles import is_admin
from utils.menu_manager import menu_manager
from services.tenant_service import TenantService
from keyboards.setup_kb import (
    get_setup_main_kb,
    get_setup_channels_kb,
    get_setup_gamification_kb,
    get_setup_tariffs_kb,
    get_setup_complete_kb,
    get_channel_detection_kb,
    get_setup_confirmation_kb
)
from utils.text_utils import sanitize_text

logger = logging.getLogger(__name__)
router = Router()

class SetupStates(StatesGroup):
    """States for the setup flow."""
    waiting_for_vip_channel = State()
    waiting_for_free_channel = State()
    waiting_for_channel_confirmation = State()
    waiting_for_manual_channel_id = State()
    configuring_tariffs = State()
    configuring_gamification = State()

async def start_setup(message: Message, session: AsyncSession):
    """Start the initial setup process for new admins."""
    if not is_admin(message.from_user.id):
        await menu_manager.send_temporary_message(
            message,
            "‚ùå **Acceso Denegado**\n\nSolo los administradores pueden acceder a la configuraci√≥n inicial.",
            auto_delete_seconds=5
        )
        return
    
    tenant_service = TenantService(session)
    init_result = await tenant_service.initialize_tenant(message.from_user.id)
    
    if not init_result["success"]:
        await menu_manager.send_temporary_message(
            message,
            f"‚ùå **Error de Inicializaci√≥n**\n\n{init_result['error']}",
            auto_delete_seconds=10
        )
        return
    
    status = init_result["status"]
    
    if status["basic_setup_complete"]:
        await menu_manager.show_menu(
            message,
            "‚úÖ **Configuraci√≥n Completada**\n\n"
            "Tu bot ya est√° configurado y listo para usar. Puedes acceder al "
            "panel de administraci√≥n o realizar configuraciones adicionales.",
            get_setup_complete_kb(),
            session,
            "setup_complete"
        )
    else:
        await menu_manager.show_menu(
            message,
            "üöÄ **Bienvenido a la Configuraci√≥n Inicial**\n\n"
            "¬°Hola! Vamos a configurar tu bot paso a paso para que est√© listo "
            "para tus usuarios. Este proceso es r√°pido y f√°cil.\n\n"
            "**¬øQu√© vamos a configurar?**\n"
            "‚Ä¢ üì¢ Canales (VIP y/o Gratuito)\n"
            "‚Ä¢ üí≥ Tarifas de suscripci√≥n\n"
            "‚Ä¢ üéÆ Sistema de gamificaci√≥n\n\n"
            "¬°Empecemos!",
            get_setup_main_kb(),
            session,
            "setup_main"
        )

@router.message(Command("setup"))
async def setup_command(message: Message, session: AsyncSession):
    """Setup command handler."""
    await start_setup(message, session)

@router.callback_query(F.data == "setup_channels")
async def setup_channels_menu(callback: CallbackQuery, session: AsyncSession):
    """Show channel configuration options."""
    if not is_admin(callback.from_user.id):
        return await callback.answer("Acceso denegado", show_alert=True)
    
    await menu_manager.update_menu(
        callback,
        "üì¢ **Configuraci√≥n de Canales**\n\n"
        "Los canales son el coraz√≥n de tu bot. Puedes configurar:\n\n"
        "üîê **Canal VIP**: Para suscriptores premium\n"
        "üÜì **Canal Gratuito**: Para usuarios sin suscripci√≥n\n\n"
        "**Recomendaci√≥n**: Configura al menos un canal para empezar. "
        "Puedes agregar m√°s canales despu√©s desde el panel de administraci√≥n.",
        get_setup_channels_kb(),
        session,
        "setup_channels"
    )
    await callback.answer()

@router.callback_query(F.data == "setup_vip_channel")
async def setup_vip_channel(callback: CallbackQuery, state: FSMContext):
    """Start VIP channel configuration."""
    if not is_admin(callback.from_user.id):
        return await callback.answer("Acceso denegado", show_alert=True)
    
    await callback.message.edit_text(
        "üîê **Configurar Canal VIP**\n\n"
        "Para configurar tu canal VIP, reenv√≠a cualquier mensaje de tu canal aqu√≠. "
        "El bot detectar√° autom√°ticamente el ID del canal.\n\n"
        "**Importante**: Aseg√∫rate de que el bot sea administrador del canal "
        "con permisos para invitar usuarios.",
        reply_markup=get_setup_confirmation_kb("cancel_channel_setup")
    )
    
    await state.set_state(SetupStates.waiting_for_vip_channel)
    await callback.answer()

@router.callback_query(F.data == "setup_free_channel")
async def setup_free_channel(callback: CallbackQuery, state: FSMContext):
    """Start free channel configuration."""
    if not is_admin(callback.from_user.id):
        return await callback.answer("Acceso denegado", show_alert=True)
    
    await callback.message.edit_text(
        "üÜì **Configurar Canal Gratuito**\n\n"
        "Para configurar tu canal gratuito, reenv√≠a cualquier mensaje de tu canal aqu√≠. "
        "El bot detectar√° autom√°ticamente el ID del canal.\n\n"
        "**Importante**: Aseg√∫rate de que el bot sea administrador del canal "
        "con permisos para aprobar solicitudes de uni√≥n.",
        reply_markup=get_setup_confirmation_kb("cancel_channel_setup")
    )
    
    await state.set_state(SetupStates.waiting_for_free_channel)
    await callback.answer()

@router.message(SetupStates.waiting_for_vip_channel)
async def process_vip_channel(message: Message, state: FSMContext, session: AsyncSession):
    """Process VIP channel configuration."""
    if not is_admin(message.from_user.id):
        return
    
    channel_id = None
    channel_title = None
    
    if message.forward_from_chat:
        channel_id = message.forward_from_chat.id
        channel_title = message.forward_from_chat.title
    else:
        try:
            channel_id = int(message.text.strip())
        except ValueError:
            await menu_manager.send_temporary_message(
                message,
                "‚ùå **ID Inv√°lido**\n\nPor favor, reenv√≠a un mensaje del canal o ingresa un ID v√°lido.",
                auto_delete_seconds=5
            )
            return
    
    # Store channel info for confirmation
    await state.update_data(
        channel_type="vip",
        channel_id=channel_id,
        channel_title=channel_title
    )
    
    title_text = f" ({channel_title})" if channel_title else ""
    
    await message.answer(
        f"‚úÖ **Canal VIP Detectado**\n\n"
        f"**ID del Canal**: `{channel_id}`{title_text}\n\n"
        f"¬øEs este el canal correcto?",
        reply_markup=get_channel_detection_kb()
    )
    
    await state.set_state(SetupStates.waiting_for_channel_confirmation)

@router.message(SetupStates.waiting_for_free_channel)
async def process_free_channel(message: Message, state: FSMContext, session: AsyncSession):
    """Process free channel configuration."""
    if not is_admin(message.from_user.id):
        return
    
    channel_id = None
    channel_title = None
    
    if message.forward_from_chat:
        channel_id = message.forward_from_chat.id
        channel_title = message.forward_from_chat.title
    else:
        try:
            channel_id = int(message.text.strip())
        except ValueError:
            await menu_manager.send_temporary_message(
                message,
                "‚ùå **ID Inv√°lido**\n\nPor favor, reenv√≠a un mensaje del canal o ingresa un ID v√°lido.",
                auto_delete_seconds=5
            )
            return
    
    # Store channel info for confirmation
    await state.update_data(
        channel_type="free",
        channel_id=channel_id,
        channel_title=channel_title
    )
    
    title_text = f" ({channel_title})" if channel_title else ""
    
    await message.answer(
        f"‚úÖ **Canal Gratuito Detectado**\n\n"
        f"**ID del Canal**: `{channel_id}`{title_text}\n\n"
        f"¬øEs este el canal correcto?",
        reply_markup=get_channel_detection_kb()
    )
    
    await state.set_state(SetupStates.waiting_for_channel_confirmation)

@router.callback_query(F.data == "confirm_channel")
async def confirm_channel_setup(callback: CallbackQuery, state: FSMContext, session: AsyncSession):
    """Confirm and save channel configuration."""
    if not is_admin(callback.from_user.id):
        return await callback.answer("Acceso denegado", show_alert=True)
    
    data = await state.get_data()
    channel_type = data.get("channel_type")
    channel_id = data.get("channel_id")
    channel_title = data.get("channel_title")
    
    if not channel_id:
        await callback.answer("Error: No se encontr√≥ informaci√≥n del canal", show_alert=True)
        return
    
    tenant_service = TenantService(session)
    
    # Configure the channel
    if channel_type == "vip":
        result = await tenant_service.configure_channels(
            callback.from_user.id,
            vip_channel_id=channel_id,
            channel_titles={"vip": channel_title} if channel_title else None
        )
    else:
        result = await tenant_service.configure_channels(
            callback.from_user.id,
            free_channel_id=channel_id,
            channel_titles={"free": channel_title} if channel_title else None
        )
    
    if result["success"]:
        channel_name = "VIP" if channel_type == "vip" else "Gratuito"
        await menu_manager.update_menu(
            callback,
            f"‚úÖ **Canal {channel_name} Configurado**\n\n"
            f"El canal ha sido configurado exitosamente.\n\n"
            f"**Siguiente paso**: ¬øQuieres configurar m√°s elementos?",
            get_setup_main_kb(),
            session,
            "setup_main"
        )
    else:
        await callback.message.edit_text(
            f"‚ùå **Error de Configuraci√≥n**\n\n{result['error']}",
            reply_markup=get_setup_channels_kb()
        )
    
    await state.clear()
    await callback.answer()

@router.callback_query(F.data == "setup_gamification")
async def setup_gamification_menu(callback: CallbackQuery, session: AsyncSession):
    """Show gamification setup options."""
    if not is_admin(callback.from_user.id):
        return await callback.answer("Acceso denegado", show_alert=True)
    
    await menu_manager.update_menu(
        callback,
        "üéÆ **Configuraci√≥n de Gamificaci√≥n**\n\n"
        "El sistema de gamificaci√≥n mantiene a tus usuarios comprometidos con:\n\n"
        "üéØ **Misiones**: Tareas que los usuarios pueden completar\n"
        "üèÖ **Insignias**: Reconocimientos por logros\n"
        "üéÅ **Recompensas**: Premios por acumular puntos\n"
        "üìä **Niveles**: Sistema de progresi√≥n\n\n"
        "**Recomendaci√≥n**: Usa la configuraci√≥n por defecto para empezar r√°pido.",
        get_setup_gamification_kb(),
        session,
        "setup_gamification"
    )
    await callback.answer()

@router.callback_query(F.data == "setup_default_game")
async def setup_default_gamification(callback: CallbackQuery, session: AsyncSession):
    """Set up default gamification elements."""
    if not is_admin(callback.from_user.id):
        return await callback.answer("Acceso denegado", show_alert=True)
    
    tenant_service = TenantService(session)
    result = await tenant_service.setup_default_gamification(callback.from_user.id)
    
    if result["success"]:
        await menu_manager.update_menu(
            callback,
            "‚úÖ **Gamificaci√≥n Configurada**\n\n"
            "Se ha configurado el sistema de gamificaci√≥n con:\n\n"
            f"üéØ **Misiones creadas**: {len(result['missions_created'])}\n"
            f"üìä **Niveles inicializados**: {'S√≠' if result['levels_initialized'] else 'No'}\n"
            f"üèÜ **Logros inicializados**: {'S√≠' if result['achievements_initialized'] else 'No'}\n\n"
            "Los usuarios ya pueden empezar a ganar puntos y completar misiones.",
            get_setup_main_kb(),
            session,
            "setup_main"
        )
    else:
        await callback.message.edit_text(
            f"‚ùå **Error de Configuraci√≥n**\n\n{result['error']}",
            reply_markup=get_setup_gamification_kb()
        )
    
    await callback.answer()

@router.callback_query(F.data == "setup_tariffs")
async def setup_tariffs_menu(callback: CallbackQuery, session: AsyncSession):
    """Show tariff setup options."""
    if not is_admin(callback.from_user.id):
        return await callback.answer("Acceso denegado", show_alert=True)
    
    await menu_manager.update_menu(
        callback,
        "üí≥ **Configuraci√≥n de Tarifas VIP**\n\n"
        "Las tarifas determinan los precios y duraci√≥n de las suscripciones VIP.\n\n"
        "**Opciones disponibles**:\n"
        "üíé **B√°sica**: Tarifa est√°ndar de 30 d√≠as\n"
        "üëë **Premium**: Tarifa de 90 d√≠as con descuento\n"
        "üéØ **Personalizada**: Crea tus propias tarifas\n\n"
        "**Recomendaci√≥n**: Empieza con las tarifas b√°sica y premium.",
        get_setup_tariffs_kb(),
        session,
        "setup_tariffs"
    )
    await callback.answer()

@router.callback_query(F.data == "setup_basic_tariff")
async def setup_basic_tariff(callback: CallbackQuery, session: AsyncSession):
    """Set up basic tariff."""
    if not is_admin(callback.from_user.id):
        return await callback.answer("Acceso denegado", show_alert=True)
    
    tenant_service = TenantService(session)
    result = await tenant_service.create_default_tariffs(callback.from_user.id)
    
    if result["success"]:
        tariffs_text = "\n".join([f"‚Ä¢ {name}" for name in result["tariffs_created"]])
        await menu_manager.update_menu(
            callback,
            f"‚úÖ **Tarifas Creadas**\n\n"
            f"Se han creado las siguientes tarifas:\n\n{tariffs_text}\n\n"
            f"Puedes modificar precios y crear tarifas adicionales desde el panel de administraci√≥n.",
            get_setup_main_kb(),
            session,
            "setup_main"
        )
    else:
        await callback.message.edit_text(
            f"‚ùå **Error de Configuraci√≥n**\n\n{result['error']}",
            reply_markup=get_setup_tariffs_kb()
        )
    
    await callback.answer()

@router.callback_query(F.data == "setup_complete")
async def complete_setup(callback: CallbackQuery, session: AsyncSession):
    """Complete the setup process."""
    if not is_admin(callback.from_user.id):
        return await callback.answer("Acceso denegado", show_alert=True)
    
    tenant_service = TenantService(session)
    summary = await tenant_service.get_tenant_summary(callback.from_user.id)
    
    if "error" in summary:
        await callback.message.edit_text(
            f"‚ùå **Error**\n\n{summary['error']}",
            reply_markup=get_setup_main_kb()
        )
        return
    
    status = summary["configuration_status"]
    
    status_text = "‚úÖ **Configuraci√≥n Completada**\n\n"
    status_text += "**Estado de tu bot**:\n"
    status_text += f"üì¢ Canales: {'‚úÖ' if status['channels_configured'] else '‚ùå'}\n"
    status_text += f"üí≥ Tarifas: {'‚úÖ' if status['tariffs_configured'] else '‚ùå'}\n"
    status_text += f"üéÆ Gamificaci√≥n: {'‚úÖ' if status['gamification_configured'] else '‚ùå'}\n\n"
    
    if status["basic_setup_complete"]:
        status_text += "üéâ **¬°Tu bot est√° listo para usar!**\n\n"
        status_text += "Puedes empezar a invitar usuarios y gestionar tu comunidad."
    else:
        status_text += "‚ö†Ô∏è **Configuraci√≥n incompleta**\n\n"
        status_text += "Algunas funciones pueden no estar disponibles hasta completar la configuraci√≥n."
    
    await menu_manager.update_menu(
        callback,
        status_text,
        get_setup_complete_kb(),
        session,
        "setup_complete"
    )
    await callback.answer()

@router.callback_query(F.data == "skip_setup")
async def skip_setup(callback: CallbackQuery, session: AsyncSession):
    """Skip setup and go to admin panel."""
    if not is_admin(callback.from_user.id):
        return await callback.answer("Acceso denegado", show_alert=True)
    
    from keyboards.admin_main_kb import get_admin_main_kb
    
    await menu_manager.update_menu(
        callback,
        "‚è≠Ô∏è **Configuraci√≥n Omitida**\n\n"
        "Has omitido la configuraci√≥n inicial. Puedes configurar tu bot "
        "en cualquier momento desde el panel de administraci√≥n.\n\n"
        "**Nota**: Algunas funciones pueden no estar disponibles hasta "
        "completar la configuraci√≥n b√°sica.",
        get_admin_main_kb(),
        session,
        "admin_main"
    )
    await callback.answer()

# Error handlers and cleanup
@router.callback_query(F.data.startswith("cancel_"))
async def cancel_setup_action(callback: CallbackQuery, state: FSMContext, session: AsyncSession):
    """Cancel current setup action."""
    await state.clear()
    await menu_manager.update_menu(
        callback,
        "‚ùå **Acci√≥n Cancelada**\n\n"
        "La configuraci√≥n ha sido cancelada. Puedes intentar nuevamente cuando quieras.",
        get_setup_main_kb(),
        session,
        "setup_main"
    )
    await callback.answer()